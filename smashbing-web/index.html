<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
</head>

<body>
    <canvas id="game" width="64" height="64" style="width: 256px; height: 256px;"></canvas>
    <script src="smashbing_web.js"></script>
    <script>
        delete WebAssembly.instantiateStreaming;
        const CANVAS_SCALE = 64.0 / 256.0;
        const DELTA_TIME = 1.0 / 60.0;

        let gameCanvas = document.getElementById("game");
        let ctx = gameCanvas.getContext("2d");
        var game;

        gameCanvas.onclick = function (evt) {
            let x = evt.clientX * CANVAS_SCALE;
            let y = evt.clientY * CANVAS_SCALE;
            console.log("onclick @ %f %f", x, y);
            game.fire_at(x, y);
        }

        function draw_rect(x, y, w, h, c) {
            ctx.fillStyle = c;
            ctx.fillRect(x, y, w, h);
        }

        function exit() {
            // TODO: Can't close window from JS; Figure out what to do
            // about this.
            window.close();
        }

        let sounds = {
            "bounce": new Audio("./sounds/bounce.wav"),
            "bounce_charge": new Audio("./sounds/bounce-charge.wav"),
            "impulse": new Audio("./sounds/impulse.wav"),
            "impulse_exhaust": new Audio("./sounds/impulse-exhaust.wav"),
            "break1": new Audio("./sounds/break1.wav"),
            "break2": new Audio("./sounds/break2.wav"),
            "break3": new Audio("./sounds/break3.wav"),
            "break4": new Audio("./sounds/break4.wav"),
            "win": new Audio("./sounds/win.wav")
        };

        function play_sound(sound_key) {
            // TODO: Figure out how to make this less laggy
            let sound = sounds[sound_key]
            if (sound) {
                sound.currentTime = 0;
                sound.play();
            }
        }

        const { EmbeddedGame } = wasm_bindgen;

        function run() {
            game = new EmbeddedGame();
            setInterval(
                function () { game.update(DELTA_TIME); },
                DELTA_TIME * 1000,
            );
        };

        wasm_bindgen("./smashbing_web_bg.wasm")
            .then(run).catch(console.error);
    </script>
</body>

</html>